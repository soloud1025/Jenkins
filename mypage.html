<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오이+ · 마이페이지</title>
  <style>
    :root{
      --bg:#f7f7f7; --card:#ffffff; --ink:#1f2937; --ink-dim:#6b7280;
      --accent:#53e3ac; --accent-hover:#34c693; --line:#e5e7eb; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; background:var(--bg); color:var(--ink); line-height:1.6; padding-bottom:64px}

    /* 상단 내비 */
    .nav{position:sticky; top:0; z-index:100; display:flex; justify-content:space-between; align-items:center; padding:16px 24px; background:#fff; border-bottom:1px solid var(--line)}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px}
    .brand svg{display:block}
    .nav-actions{display:flex; gap:10px}
    .nav-actions a{display:inline-block; padding:8px 16px; border-radius:999px; font-size:14px; font-weight:600; text-decoration:none; transition:.2s}
    .nav-actions .ghost{color:var(--accent); border:1.5px solid var(--accent); background:#fff}
    .nav-actions .ghost:hover{background:var(--accent); color:#fff}
    .nav-actions .danger{color:#fff; background:var(--danger)}
    .nav-actions .danger:hover{filter:brightness(.95)}

    /* 헤더 */
    .page-header{max-width:1080px; margin:24px auto 0; padding:0 20px 10px; display:flex; align-items:center; gap:16px}
    .avatar{width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,#53e3ac22,#53e3ac66); display:grid; place-items:center; font-weight:900; color:#0f5132; border:1px solid var(--line)}
    .page-header h1{margin:0; font-size:22px; font-weight:900}
    .page-header .meta{color:var(--ink-dim); font-size:13px}

    /* 본문 */
    .container{max-width:1080px; margin:0 auto; padding:0 20px 24px}
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.04)}
    .card .hd{display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0; font-size:16px; font-weight:800}
    .card .bd{padding:16px 18px}

    .kv{display:grid; grid-template-columns:140px 1fr; gap:8px; padding:10px 0; border-bottom:1px dashed var(--line)}
    .kv:last-child{border-bottom:none}
    .kv .k{color:var(--ink-dim); font-size:13px}
    .kv .v{font-weight:600}

    .pills{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .pill{padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; font-size:13px; color:#374151; display:inline-flex; gap:6px; align-items:center}
    .pill .price{color:#6b7280; font-size:12px}

    .price-xl{font-size:32px; font-weight:900}
    .dim{color:var(--ink-dim)}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; font-weight:700; font-size:14px; cursor:pointer; text-decoration:none; border:1px solid var(--line); background:#fff; color:var(--ink)}
    .btn:hover{border-color:var(--accent); color:var(--accent)}
    .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
    .btn.primary:hover{background:var(--accent-hover)}

    /* 하단 네비 */
    .bottom-nav{position:fixed; left:0; right:0; bottom:0; height:64px; background:#fff; border-top:1px solid var(--line); display:flex; justify-content:space-around; align-items:center; z-index:200}
    .bottom-nav a{flex:1; text-align:center; text-decoration:none; color:var(--ink-dim); font-size:12px; display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 0}
    .bottom-nav a.active{color:var(--accent); font-weight:700}
  </style>

  <!-- 공통 API -->
  <script>
    window.API_BASE = window.API_BASE || location.origin;

    async function api(path, opts = {}) {
      const url = path.startsWith('http') ? path : (window.API_BASE + path);
      opts.credentials = 'include';
      opts.headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    async function isLoggedIn() {
      try { const me = await api('/api/me', { method:'GET' }); return !!(me && (me.user_id || me.name || me.user_name)); }
      catch { return false; }
    }

    const KRW = (n)=> '₩' + Number(n||0).toLocaleString('ko-KR');
  </script>
</head>
<body>
  <!-- 상단 내비 -->
  <nav class="nav">
    <div class="brand">
      <svg width="26" height="26" viewBox="0 0 48 48" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#53e3ac"/><stop offset="1" stop-color="#34c693"/></linearGradient></defs>
        <circle cx="24" cy="24" r="20" fill="url(#g)" stroke="#2aa57f" stroke-width="2"/>
        <circle cx="24" cy="24" r="14" fill="none" stroke="#ffffff88" stroke-width="2"/>
        <rect x="22" y="15" width="4" height="18" rx="2" fill="#fff"/><rect x="15" y="22" width="18" height="4" rx="2" fill="#fff"/>
      </svg>
      <a href="/" style="text-decoration:none;color:inherit;font-weight:900">오이+</a>
    </div>
    <div class="nav-actions" id="navUser"></div>
  </nav>

  <!-- 헤더 -->
  <header class="page-header">
    <div id="avatar" class="avatar">U</div>
    <div>
      <h1 id="displayName">사용자 <span id="displayEmail" class="meta">· </span></h1>
      <div class="meta">가입일 <span id="joinedAt">-</span></div>
    </div>
  </header>

  <!-- 본문 -->
  <main class="container">
    <div class="grid">
      <!-- 좌측: 내 정보 -->
      <section class="card">
        <div class="hd">
          <h2>내 정보</h2>
          <a class="btn" href="/profile/edit">정보 수정</a>
        </div>
        <div class="bd">
          <div class="kv"><div class="k">아이디</div><div id="vUserName" class="v">-</div></div>
          <div class="kv"><div class="k">이름</div><div id="vName" class="v">-</div></div>
          <div class="kv"><div class="k">이메일</div><div id="vEmail" class="v">-</div></div>
          <div class="kv"><div class="k">연락처</div><div id="vPhone" class="v">-</div></div>
        </div>
      </section>

      <!-- 우측: 결제/구독 요약 -->
      <section class="card">
        <div class="hd">
          <h2>결제 요약</h2>
          <a class="btn" href="/billing">결제/구독 관리</a>
        </div>
        <div class="bd" name="subscript"></div>
      </section>
    </div>
  </main>

  <!-- 하단 네비 -->
  <nav class="bottom-nav">
    <a href="/"><svg width="20" height="20" fill="currentColor"><path d="M10 2L2 9h2v9h4v-6h4v6h4V9h2z"/></svg>홈</a>
    <a href="/payment.html"><svg width="20" height="20" fill="currentColor"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>구독하기</a>
    <a href="/work.html"><svg width="20" height="20" fill="currentColor"><path d="M4 6h16v12H4z"/></svg>콘텐츠</a>
    <a href="/mypage.html" class="active"><svg width="20" height="20" fill="currentColor"><path d="M12 12a5 5 0 100-10 5 5 0 000 10m0 2c-4.33 0-8 2.17-8 5v3h16v-3c0-2.83-3.67-5-8-5z"/></svg>MY</a>
  </nav>

  <script>
    // 텍스트 유틸
    const setText = (selOrEl, v)=> {
      const el = typeof selOrEl === 'string' ? document.querySelector(selOrEl) : selOrEl;
      if (el) el.textContent = (v ?? '-') + '';
    };
    const onlyDate = (iso)=> {
      try{
        if (!iso) return '-';
        if (iso.includes(' ')) return iso.split(' ')[0];
        const d = new Date(iso);
        return isNaN(d) ? '-' : d.toISOString().slice(0,10);
      }catch{ return '-'; }
    };

    // 네비 상태 동기화 + 로그아웃
    async function hydrateNav(){
      const slot = document.getElementById('navUser');
      if (!slot) return;
      try{
        const me = await api('/api/me', { method:'GET' });
        const name = (me?.name && me.name.trim()) || me?.user_name || '사용자';
        slot.innerHTML = `
          <span class="hello" style="font-weight:800;">${name}님</span>
          <a href="/settings" class="ghost">설정</a>
          <a href="#" id="btnLogout" class="danger">로그아웃</a>
        `;
        document.getElementById('btnLogout')?.addEventListener('click', async (e)=>{
          e.preventDefault();
          try { await api('/api/logout', { method:'POST' }); } finally { location.href = '/login.html'; }
        });
      }catch{
        slot.innerHTML = `
          <a href="/login.html" class="ghost">로그인</a>
          <a href="/register.html" class="ghost" style="background:var(--accent);color:#fff;border-color:var(--accent)">회원가입</a>
        `;
      }
    }

    // 내 정보
    async function loadMe(){
      // 미로그인 차단
      if (!(await isLoggedIn())) {
        location.href = `/login.html?next=${encodeURIComponent('/mypage.html')}`;
        return;
      }

      try{
        const me = await api('/api/me', { method:'GET' });

        const dispName = me.name || me.user_name || '사용자';
        setText('#displayName', dispName + ' ');
        setText('#displayEmail', '· ' + (me.email || '-'));

        const avatar = document.getElementById('avatar');
        if (avatar) avatar.textContent = (dispName || 'U').trim().charAt(0).toUpperCase();

        setText('#joinedAt', onlyDate(me.created_at));
        setText('#vUserName', me.user_name || '-');
        setText('#vName', me.name || '-');
        setText('#vEmail', me.email || '-');
        setText('#vPhone', me.phone_number || '-');
      }catch(e){
        console.error(e);
        alert('프로필을 불러오지 못했습니다.');
      }
    }

    // 구독 요약
    async function loadSubscriptions(){
      const container = document.querySelector('.card [name="subscript"]');
      if (!container) return;

      try{
        const subs = await api('/api/subscriptions', { method:'GET' });
        if (!Array.isArray(subs) || subs.length === 0){
          container.innerHTML = `<div class="dim">활성화된 구독이 없습니다.</div>`;
          return;
        }

        let total = 0;
        const wrap = document.createElement('div');
        wrap.className = 'pills';

        for (const s of subs){
          const price = Number(s.price || 0);
          total += price;

          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.innerHTML = `
            ${s.service_name || '서비스'}
            <span class="price">${KRW(price)}</span>
          `;
          wrap.appendChild(pill);
        }

        container.innerHTML = '';
        const totalEl = document.createElement('div');
        totalEl.className = 'price-xl';
        totalEl.innerHTML = `<span>${KRW(total)}</span><span class="dim">/월</span>`;

        container.appendChild(totalEl);
        container.appendChild(wrap);
      }catch(e){
        console.error('구독 목록 불러오기 실패', e);
        container.innerHTML = `<div class="dim">구독 정보를 불러오지 못했습니다.</div>`;
      }
    }

    (async () => {
      await hydrateNav();
      await loadMe();
      await loadSubscriptions();
    })();
  </script>
</body>
</html>
