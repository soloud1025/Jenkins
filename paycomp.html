<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오이+ · 결제 완료</title>
  <style>
    :root{
      --bg:#f7f7f7;
      --card:#ffffff;
      --ink:#1f2937;
      --ink-dim:#6b7280;
      --accent:#53e3ac;
      --accent-hover:#34c693;
      --line:#e5e7eb;
      --success:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg);color:var(--ink);line-height:1.6;
    }
    /* 상단 내비 */
    .nav{
      position:sticky;top:0;z-index:100;
      display:flex;justify-content:space-between;align-items:center;
      padding:16px 24px;background:#fff;border-bottom:1px solid var(--line);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .brand svg{display:block}
    .nav-actions{display:flex;gap:10px}
    .nav-actions a{
      display:inline-block;padding:8px 16px;border-radius:999px;
      font-size:14px;font-weight:700;text-decoration:none;transition:.2s;
    }
    .nav-actions .ghost{color:var(--accent);border:1.5px solid var(--accent);background:#fff}
    .nav-actions .ghost:hover{background:var(--accent);color:#fff}
    /* 본문 */
    .wrap{max-width:720px;margin:48px auto;padding:0 20px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06);padding:28px;text-align:center;
    }
    .check{
      width:64px;height:64px;border-radius:50%;
      display:inline-grid;place-items:center;margin:0 auto 12px;
      background:var(--accent);color:#fff;
      box-shadow:0 6px 16px rgba(83,227,172,.35);
    }
    .title{margin:8px 0 6px 0;font-size:26px;font-weight:900}
    .meta{color:var(--ink-dim);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
    .item{
      text-align:left;background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px 16px;
    }
    .item .k{color:var(--ink-dim);font-size:12px}
    .item .v{font-weight:800;margin-top:4px}
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#fff;color:#374151}
    .btns{display:flex;gap:10px;justify-content:center;margin-top:20px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 18px;border-radius:12px;font-weight:800;border:0;cursor:pointer;
      background:var(--accent);color:#fff;transition:.2s;
    }
    .btn:hover{background:var(--accent-hover)}
    .btn.ghost{background:#fff;color:var(--accent);border:1.5px solid var(--accent)}
    .btn.ghost:hover{background:var(--accent);color:#fff}
    .note{margin-top:12px;color:var(--ink-dim);font-size:12px}
    @media (max-width:640px){
      .grid{grid-template-columns:1fr}
      .btns{flex-direction:column}
      .btn{width:100%}
    }
  </style>

  <!-- 공통 API 헬퍼 -->
  <script>
    // 혼합콘텐츠 방지: 현재 오리진 사용
    window.API_BASE = window.API_BASE || location.origin;
    async function api(path, opts = {}) {
      const url = path.startsWith("http") ? path : (window.API_BASE + path);
      opts.credentials = "include";
      opts.headers = Object.assign({ "Content-Type": "application/json" }, opts.headers || {});
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }
  </script>
</head>
<body>
  <!-- 상단 내비 -->
  <nav class="nav">
    <div class="brand">
      <!-- 오이+ 로고 -->
      <svg width="26" height="26" viewBox="0 0 48 48" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#53e3ac"/><stop offset="1" stop-color="#34c693"/>
          </linearGradient>
        </defs>
        <circle cx="24" cy="24" r="20" fill="url(#g)" stroke="#2aa57f" stroke-width="2"/>
        <circle cx="24" cy="24" r="14" fill="none" stroke="#ffffff88" stroke-width="2"/>
        <rect x="22" y="15" width="4" height="18" rx="2" fill="#fff"/>
        <rect x="15" y="22" width="18" height="4" rx="2" fill="#fff"/>
      </svg>
      <a href="/" style="text-decoration:none;color:inherit">오이+</a>
    </div>
    <div class="nav-actions" id="navUser"></div>
  </nav>

  <!-- 본문 -->
  <main class="wrap">
    <section class="card" aria-live="polite">
      <div class="check" aria-hidden="true">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
      </div>
      <h1 class="title">결제가 완료되었습니다</h1>
      <p class="meta">구독이 활성화 되었어요. 아래 영수증 정보를 확인하세요.</p>

      <div class="grid">
        <div class="item">
          <div class="k">서비스명</div>
          <div class="v" id="r-plan">-</div>
          <div id="r-services" class="pills" style="display:none"></div>
        </div>
        <div class="item">
          <div class="k">청구 금액(월)</div>
          <div class="v" id="r-amount">-</div>
        </div>
        <div class="item">
          <div class="k">결제 일시</div>
          <div class="v" id="r-time">-</div>
        </div>
        <div class="item">
          <div class="k">그룹 id</div>
          <div class="v" id="r-id">-</div>
        </div>
      </div>

      <div class="btns">
        <button class="btn" onclick="location.href='/mypage.html'">마이페이지로</button>
        <button class="btn ghost" onclick="location.href='/'">메인으로</button>
        <button class="btn ghost" id="btnReceipt">영수증 저장(PDF)</button>
      </div>

      <p class="note">※ 데모 페이지입니다. 실제 결제는 처리되지 않습니다.</p>
    </section>
  </main>

  <script>
  (function(){
    const KRW = n => '₩' + Number(n||0).toLocaleString('ko-KR');

    const rPlan = document.getElementById('r-plan');
    const rAmt  = document.getElementById('r-amount');
    const rTime = document.getElementById('r-time');
    const rId   = document.getElementById('r-id');

    // payment.html에서 sessionStorage에 저장한 payReceipt 사용
    const raw = sessionStorage.getItem('payReceipt');
    let receipt = null;
    try { receipt = raw ? JSON.parse(raw) : null; } catch(_) {}

    const now = new Date();
    const ts = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')
              +' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');

    if (!receipt || !Array.isArray(receipt.lines) || receipt.lines.length === 0){
      rPlan.textContent = '-';
      rAmt.textContent  = '₩0';
      rTime.textContent = ts;
      rId.textContent   = '-';
      return;
    }

    // 서비스명 매핑용: /api/services → api() 사용
    api('/api/services', { method:'GET' })
      .then(all => {
        const nameById = new Map();
        (all||[]).forEach(s => nameById.set(Number(s.service_id), s.service_name));

        // 각 라인 아이템(서비스명, 그룹ID, 금액)
        const items = receipt.lines.map(it => ({
          name: nameById.get(Number(it.service_id)) || `서비스 ${it.service_id}`,
          group_id: Number(it.group_id),
          price: Number(it.price || 0)
        }));

        // (1) 서비스명·그룹ID·금액 리스트
        rPlan.innerHTML = items.map(it => `
          <div style="display:flex;justify-content:space-between;gap:8px;">
            <span><strong>${it.name}</strong> <span class="meta">(#${it.group_id})</span></span>
            <span>${KRW(it.price)}</span>
          </div>
        `).join('');

        // (2) 청구 금액(월): **부가세 제거** — 선택 금액 합계 그대로
        const sub = items.reduce((a,b)=>a+b.price,0);
        rAmt.textContent = KRW(sub);

        // (3) 결제 일시
        const paid = (receipt.paid_at || '').replace('T',' ').slice(0,16);
        rTime.textContent = paid || ts;

        // (4) 그룹 ID: 한 개면 그대로, 여러 개면 "첫번째 외 N개"
        if (items.length === 1) {
          rId.textContent = String(items[0].group_id);
        } else {
          rId.textContent = `${items[0].group_id} 외 ${items.length - 1}개`;
        }
      })
      .catch(() => {
        rPlan.textContent = '서비스 정보를 불러오지 못했습니다.';
      });

    // PDF 저장
    document.getElementById('btnReceipt')?.addEventListener('click', () => window.print());
  })();
  </script>

  <script>
  (() => {
    if (window.__NAV_HYDRATED__) return;
    window.__NAV_HYDRATED__ = true;

    const slot = document.getElementById('navUser');
    if (!slot) return;

    const render = (html) => { slot.innerHTML = html; };
    const displayName = (me) => (me?.name && me.name.trim()) || me?.user_name || '사용자';

    (async () => {
      try {
        const me = await api('/api/me', { method:'GET' });
        const isAuth = !!(me && (me.user_id || me.name || me.user_name));
        if (isAuth) {
          const name = displayName(me);
          render(`
            <span class="hello" style="font-weight:800;">${name}님</span>
            <a href="/mypage.html" class="ghost">마이페이지</a>
            <a href="#" id="btnLogout" class="ghost" style="color:#fff;background:#ef4444;border-color:#ef4444">로그아웃</a>
          `);
          document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
            e.preventDefault();
            try { await api('/api/logout', { method:'POST' }); } finally { location.href = '/'; }
          });
        } else {
          render(`
            <a href="/login.html" class="ghost">로그인</a>
            <a href="/register.html" class="ghost">회원가입</a>
          `);
        }
      } catch {
        // 실패 시 기본 버튼 유지
      }
    })();
  })();
  </script>
</body>
</html>
