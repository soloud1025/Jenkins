<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오이+ · 회원가입</title>
  <style>
    :root{
      --bg:#f7f7f7;
      --card:#ffffff;
      --ink:#1f2937;
      --ink-dim:#6b7280;
      --accent:#53e3ac;      /* 민트 */
      --accent-hover:#34c693;
      --line:#e5e7eb;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
      padding-bottom:64px;
    }

    /* 상단 내비 */
    .nav{
      display:flex;justify-content:space-between;align-items:center;
      padding:16px 24px;background:#fff;border-bottom:1px solid var(--line);
      position:sticky;top:0;z-index:100;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .brand svg{display:block}

    /* 우측 버튼 */
    .nav-actions{display:flex;gap:10px}
    .nav-actions a{
      display:inline-block;padding:8px 16px;border-radius:999px;
      font-size:14px;font-weight:600;text-decoration:none;transition:.2s;
    }
    .nav-actions .login-btn{
      color:var(--accent);border:1.5px solid var(--accent);background:#fff;
    }
    .nav-actions .login-btn:hover{background:var(--accent);color:#fff}
    .nav-actions .register-btn{
      background:var(--accent);color:#fff;
    }
    .nav-actions .register-btn:hover{background:var(--accent-hover)}

    /* 헤더 */
    .page-header{text-align:center;padding:40px 20px 10px}
    .page-header h1{margin:0;font-size:28px;font-weight:900}
    .page-header p{margin:8px 0 0;color:var(--ink-dim);font-size:14px}

    /* 카드 레이아웃 */
    .container{max-width:1080px;margin:0 auto;padding:20px}
    .card{
      max-width:560px;margin:16px auto;background:var(--card);
      border:1px solid var(--line);border-radius:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06);
      padding:24px;
    }
    .card h2{margin:0 0 16px;font-size:18px;font-weight:800}

    /* 폼 */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{display:block;font-size:13px;font-weight:700;margin-bottom:6px}
    .input{
      width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;
      font-size:15px;background:#fff;outline:none;transition:.15s;
    }
    .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(83,227,172,.25)}
    .input[aria-invalid="true"]{border-color:var(--danger);box-shadow:0 0 0 3px rgba(239,68,68,.15)}
    .hint{color:var(--ink-dim);font-size:12px;margin-top:4px}

    /* 비번 토글 */
    .password-wrap{position:relative}
    .toggle-visibility{
      position:absolute;right:10px;top:50%;transform:translateY(-45%);
      border:none;background:transparent;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      color:var(--ink-dim);padding:4px;border-radius:50%;
    }
    .toggle-visibility:hover{color:var(--accent)}
    .toggle-visibility svg{width:20px;height:20px}

    .checkbox{display:flex;align-items:center;gap:8px;color:var(--ink-dim);user-select:none}
    .helper{display:flex;justify-content:center;gap:8px;margin-top:8px;color:var(--ink-dim);font-size:14px}

    /* 버튼 */
    .btn-main{
      width:100%;padding:14px 16px;border-radius:12px;border:0;cursor:pointer;
      background:var(--accent);color:#fff;font-weight:800;font-size:16px;transition:.2s;
    }
    .btn-main:hover{background:var(--accent-hover)}
  </style>

  <!-- 공통 API 헬퍼 -->
  <script>
    // 혼합콘텐츠/쿠키 이슈 방지: 현재 오리진을 그대로 사용
    window.API_BASE = window.API_BASE || location.origin;

    async function api(path, opts = {}) {
      const url = path.startsWith("http") ? path : (window.API_BASE + path);
      opts.credentials = "include";
      opts.headers = Object.assign({ "Content-Type": "application/json" }, opts.headers || {});
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    async function isLoggedIn() {
      try { const me = await api('/api/me', { method:'GET' }); return !!(me && (me.user_id || me.name || me.user_name)); }
      catch { return false; }
    }
  </script>
</head>
<body>
  <!-- 상단 내비 -->
  <nav class="nav">
    <div class="brand">
      <!-- 오이+ 로고 -->
      <svg width="26" height="26" viewBox="0 0 48 48" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#53e3ac"/><stop offset="1" stop-color="#34c693"/>
          </linearGradient>
        </defs>
        <circle cx="24" cy="24" r="20" fill="url(#g)" stroke="#2aa57f" stroke-width="2"/>
        <circle cx="24" cy="24" r="14" fill="none" stroke="#ffffff88" stroke-width="2"/>
        <rect x="22" y="15" width="4" height="18" rx="2" fill="#fff"/>
        <rect x="15" y="22" width="18" height="4" rx="2" fill="#fff"/>
      </svg>
      <a href="/" style="text-decoration:none;color:inherit">오이+</a>
    </div>
    <div class="nav-actions" id="navUser"></div>
  </nav>

  <!-- 헤더 -->
  <header class="page-header">
    <h1>회원가입</h1>
    <p>아래 정보를 입력해 계정을 만들어 주세요. (데모 UI)</p>
  </header>

  <!-- 카드 폼 -->
  <main class="container">
    <section class="card" aria-labelledby="regTitle">
      <h2 id="regTitle">기본 정보</h2>

      <form id="regForm" novalidate>
        <div class="grid">
          <div class="row">
            <label for="name">이름</label>
            <input class="input" id="name" name="name" type="text" placeholder="홍길동" required />
          </div>
          <div class="row">
            <label for="userid">아이디</label>
            <input class="input" id="userid" name="userid" type="text" placeholder="your-id" required />
            <div class="hint">영문/숫자, 대시(-), 밑줄(_)만 사용, 3~20자</div>
          </div>
        </div>

        <div class="row">
          <label for="email">이메일</label>
          <input class="input" id="email" name="email" type="email" placeholder="email@example.com" required />
        </div>

        <div class="grid">
          <div class="row password-wrap">
            <label for="password">비밀번호</label>
            <input class="input" id="password" name="password" type="password" minlength="8" required placeholder="8자 이상" />
            <button type="button" class="toggle-visibility" data-target="password" aria-label="비밀번호 표시 전환">
              <!-- open eye -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
            <div id="pHint" class="hint">영문/숫자/특수문자 조합을 권장합니다.</div>
          </div>

          <div class="row password-wrap">
            <label for="password2">비밀번호 확인</label>
            <input class="input" id="password2" name="password2" type="password" minlength="8" required placeholder="비밀번호 재입력" />
            <button type="button" class="toggle-visibility" data-target="password2" aria-label="비밀번호 표시 전환">
              <!-- open eye -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
            <div id="p2Hint" class="hint">동일한 비밀번호인지 확인해 주세요.</div>
          </div>
        </div>

        <div class="row">
          <label for="phone">연락처 (선택)</label>
          <input class="input" id="phone" name="phone" type="tel" placeholder="010-1234-5678" />
        </div>

        <div class="row" style="margin-top:4px;">
          <label class="checkbox">
            <input type="checkbox" id="agree" name="agree" required />
            (필수) 서비스 이용 약관 및 개인정보 처리방침에 동의합니다.
          </label>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn-main" type="submit">가입하기</button>
        </div>

        <p class="helper">
          <span>이미 계정이 있으신가요?</span><a href="/login.html">로그인</a>
        </p>
        <p class="hint" style="text-align:center;margin-top:6px;">※ 데모 UI입니다. 제출해도 실제로 등록되지 않습니다.</p>
      </form>
    </section>
  </main>

  <script>
    // 눈 아이콘 토글 (두 필드 공용)
    (function(){
      const openEye = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>`;
      const closedEye = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a9.965 9.965 0 012.72-4.362M9.88 9.88a3 3 0 104.243 4.243"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18"/>
        </svg>`;

      document.querySelectorAll('.toggle-visibility').forEach(btn=>{
        const targetId = btn.getAttribute('data-target');
        const input = document.getElementById(targetId);
        btn.addEventListener('click', ()=>{
          const showing = input.type === 'text';
          input.type = showing ? 'password' : 'text';
          btn.innerHTML = showing ? openEye : closedEye;
        });
      });
    })();

    // 폼 검증 & 제출
    const form = document.getElementById('regForm');

    function setInvalid(input, invalid){
      input.setAttribute('aria-invalid', invalid ? 'true' : 'false');
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); // 기본 제출 막기

      const nameEl   = document.getElementById('name');
      const useridEl = document.getElementById('userid');
      const emailEl  = document.getElementById('email');
      const p1       = document.getElementById('password');
      const p2       = document.getElementById('password2');
      const phoneEl  = document.getElementById('phone');
      const agree    = document.getElementById('agree');

      const nameVal   = (nameEl.value||'').trim();
      const useridVal = (useridEl.value||'').trim();
      const emailVal  = (emailEl.value||'').trim().toLowerCase();
      const pw1       = p1.value;
      const pw2       = p2.value;
      const phoneVal  = (phoneEl.value||'').trim();

      const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal);
      const idValid    = /^[A-Za-z0-9_-]{3,20}$/.test(useridVal);
      const samePw     = pw1 === pw2;

      setInvalid(emailEl, !emailValid);
      setInvalid(useridEl, !idValid);
      setInvalid(p1, pw1.length < 8);
      setInvalid(p2, !samePw);

      if(!emailValid){ alert('유효한 이메일을 입력해주세요.'); return; }
      if(!idValid){ alert('아이디는 3~20자, 영문/숫자/-,_만 사용할 수 있습니다.'); return; }
      if(pw1.length < 8){ alert('비밀번호는 8자 이상이어야 합니다.'); return; }
      if(!samePw){ alert('비밀번호가 일치하지 않습니다.'); return; }
      if(!agree.checked){ alert('약관에 동의해주세요.'); return; }

      const payload = {
        userid:  useridVal,
        email:   emailVal,
        password: pw1,
        phone:   phoneVal,
        name:    nameVal
      };

      try {
        const data = await api('/api/register', {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        alert('회원가입이 완료되었습니다.');
        const next = new URLSearchParams(location.search).get('next');
        location.href = next ? `/login.html?next=${encodeURIComponent(next)}` : '/login.html';
      } catch (err) {
        console.error(err);
        // 서버 메시지를 그대로 보여주기 (문자/JSON 모두 대응)
        alert(err?.message || '서버 오류가 발생했습니다.');
      }
    });
  </script>

  <!-- 네비게이션 상태 동기화 -->
  <script>
  (() => {
    if (window.__NAV_HYDRATED__) return;
    window.__NAV_HYDRATED__ = true;

    const slot = document.getElementById('navUser');
    if (!slot) return;

    const render = (html) => { slot.innerHTML = html; };
    const displayName = (me) => (me?.name && me.name.trim()) || me?.user_name || '사용자';

    (async () => {
      try {
        const me = await api('/api/me', { method:'GET' });
        const isAuth = !!(me && (me.user_id || me.name || me.user_name));

        // 이미 로그인 상태면 회원가입 페이지 대신 마이페이지로
        if (isAuth) {
          render(`
            <span class="hello" style="font-weight:800;">${displayName(me)}님</span>
            <a href="/mypage.html" class="register-btn" style="text-decoration:none">마이페이지</a>
            <a href="#" id="btnLogout" class="login-btn" style="background:#ef4444;color:#fff;border-color:#ef4444">로그아웃</a>
          `);
          document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
            e.preventDefault();
            try { await api('/api/logout', { method:'POST' }); } finally { location.href = '/'; }
          });
        } else {
          render(`
            <a href="/login.html" class="login-btn">로그인</a>
            <a href="/register.html" class="register-btn">회원가입</a>
          `);
        }
      } catch {
        // 실패 시 기본 버튼 유지
        render(`
          <a href="/login.html" class="login-btn">로그인</a>
          <a href="/register.html" class="register-btn">회원가입</a>
        `);
      }
    })();
  })();
  </script>
</body>
</html>
